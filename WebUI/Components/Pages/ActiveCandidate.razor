@page "/candidates"
@using OnlineVotingSystem.api.DTOs.Candidate
@using OnlineVotingSystem.api.DTOs.Election
@using System.ComponentModel.DataAnnotations
@using OnlineVotingSystem.api.DTOs.Position
@using WebUI.Services
@using System.Text.Json
@rendermode InteractiveServer

<main class="container mt-4 scrollable-container">
    <style>
        :root {
            --enterprise-primary: #2A5C8D;
            --enterprise-secondary: #5F7D95;
            --enterprise-accent: #48A3C6;
            --enterprise-success: #3A9D85;
            --enterprise-border: #EBEFF2;
            --enterprise-chart-bg: rgba(245, 248, 250, 0.9);
        }

        .scrollable-container {
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .candidate-card {
            border: 1px solid var(--enterprise-border);
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
        }

        .candidate-card:hover {
            transform: translateY(-0.25rem);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            border-color: var(--enterprise-accent);
        }

        .position-header {
            background: linear-gradient(135deg, var(--enterprise-primary), var(--enterprise-border));
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .candidate-actions {
            gap: 0.75rem;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }

        .candidate-bio {
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Enterprise Theme Overrides */
        .bg-primary-subtle { background-color: rgba(42,92,141,0.1) !important; }
        .border-primary { border-color: var(--enterprise-primary) !important; }
        .text-primary { color: var(--enterprise-primary) !important; }
        .text-success { color: var(--enterprise-success) !important; }
        .border-primary-subtle { border-color: var(--enterprise-border) !important; }
        .bg-success { background-color: var(--enterprise-success) !important; }

        @@media (max-width: 768px) {
            .candidate-actions {
                flex-wrap: wrap;
                justify-content: flex-end;
            }
            
            .candidate-actions .btn {
                flex: 1 1 45%;
                min-width: 100px;
            }
        }
    </style>

    <!-- Page Header -->
    <header class="mb-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h2 fw-bold text-primary mb-0">
                <i class="bi bi-people-fill me-2"></i>Registered Candidates
            </h1>
            <div class="bg-primary-subtle p-3 rounded-circle">
                <i class="bi bi-person-lines-fill fs-5 text-primary"></i>
            </div>
        </div>
        <hr class="border-primary opacity-50 my-0">
    </header>

    <!-- Status Messages -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999">
        @if (!string.IsNullOrEmpty(SuccessMessage))
        {
            <div class="alert alert-success alert-dismissible fade show d-flex align-items-center shadow">
                <i class="bi bi-check-circle-fill me-2"></i>
                <div class="flex-grow-1">@SuccessMessage</div>
                <button type="button" class="btn-close" @onclick="() => SuccessMessage = string.Empty" aria-label="Close"></button>
            </div>
        }
        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show d-flex align-items-center shadow">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div class="flex-grow-1">@ErrorMessage</div>
                <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty" aria-label="Close"></button>
            </div>
        }
    </div>

    <!-- Search & Filter Section -->
    <section class="mb-5">
        <div class="input-group input-group-lg shadow-sm">
            <input type="search" 
                   class="form-control form-control-lg border-primary-subtle" 
                   @bind="SearchTerm"
                   placeholder="Search candidates..."
                   aria-label="Search candidates">
            <button class="btn btn-primary px-4" @onclick="FilterCandidates" aria-label="Perform search">
                <i class="bi bi-search me-2"></i>Search
            </button>
        </div>
    </section>

    <!-- Candidate Details Modal -->
    @if (SelectedCandidate != null)
    {
        <div class="modal-backdrop show d-block"></div>
        <div class="modal fade show d-block" tabindex="-1" aria-modal="true" role="dialog">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
                <div class="modal-content shadow-lg">
                    <div class="modal-header text-white" style="background-color: var(--enterprise-primary);">
                        <h2 class="modal-title h5">Candidate Details</h2>
                        <button type="button" class="btn-close btn-close-white" @onclick="CloseDetails" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row align-items-center">
                            <div class="col-md-4 text-center mb-4 mb-md-0">
                                <div class="avatar-lg bg-primary-subtle rounded-circle d-inline-flex align-items-center justify-content-center">
                                    <i class="bi bi-person-badge-fill fs-1 text-primary"></i>
                                </div>
                                <h3 class="h4 mt-3 mb-1">@SelectedCandidate.Name</h3>
                                <p class="text-muted mb-0">@SelectedCandidate.Party</p>
                            </div>
                            <div class="col-md-8">
                                <dl class="row g-3">
                                    <dt class="col-sm-4 text-muted">Position</dt>
                                    <dd class="col-sm-8 fw-semibold">@SelectedCandidate.Position</dd>

                                    <dt class="col-sm-4 text-muted">Election</dt>
                                    <dd class="col-sm-8">@SelectedCandidate.Election</dd>

                                    <dt class="col-sm-4 text-muted">Bio</dt>
                                    <dd class="col-sm-8 candidate-bio">@SelectedCandidate.Bio</dd>

                                    <dt class="col-sm-4 text-muted">Party</dt>
                                    <dd class="col-sm-8">
                                        <span class="badge bg-primary-subtle text-primary fs-6">
                                            @SelectedCandidate.Party
                                        </span>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseDetails">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Edit Candidate Modal -->
    @if (ShowEditModal)
        {
            <div class="modal-backdrop show d-block"></div>
            <div class="modal fade show d-block" tabindex="-1" aria-modal="true" role="dialog">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
                    <div class="modal-content shadow-lg">
                        <div class="modal-header text-white" style="background-color: var(--enterprise-primary);">
                            <h2 class="modal-title h5">Edit Candidate</h2>
                            <button type="button" class="btn-close btn-close-white" @onclick="CloseEdit" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form @onsubmit="HandleEditSubmit">
                                <div class="row">
                                     <div class="col-md-6 mb-3">
                                        <label class="form-label">Candidate Name</label>
                                        <input type="" 
                                            class="form-control @(ValidationErrors.ContainsKey(nameof(EditingModel.PhotoUrl)) ? "is-invalid" : "")" 
                                            value=@SelectedCandidate.Name
                                             disabled/>                                        
                                    </div>

                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Political Party</label>
                                        <input type="text" 
                                            class="form-control @(ValidationErrors.ContainsKey(nameof(EditingModel.Party)) ? "is-invalid" : "")" 
                                            @bind="EditingModel.Party"
                                            @bind:event="oninput" />
                                        @if (ValidationErrors.ContainsKey(nameof(EditingModel.Party)))
                                        {
                                            <div class="invalid-feedback">
                                                @ValidationErrors[nameof(EditingModel.Party)]
                                            </div>
                                        }
                                    </div>                                    
                                   
                                    
                                   <div class="col-12 mb-3">
                                        <label class="form-label">Position</label>
                                        <select class="form-select @(ValidationErrors.ContainsKey(nameof(EditingModel.PositionId)) ? "is-invalid" : "")" 
                                                @bind="EditingModel.PositionId">
                                            @foreach (var position in AvailablePositions)
                                            {
                                                <option value="@position.Id">@position.Name</option>
                                            }
                                        </select>
                                        @if (ValidationErrors.ContainsKey(nameof(EditingModel.PositionId)))
                                        {
                                            <div class="invalid-feedback">
                                                @ValidationErrors[nameof(EditingModel.PositionId)]
                                            </div>
                                        }
                                    </div>

                                    
                                    <div class="col-12 mb-3">
                                        <label class="form-label">Biography</label>
                                        <textarea class="form-control @(ValidationErrors.ContainsKey(nameof(EditingModel.Bio)) ? "is-invalid" : "")" 
                                                rows="5"
                                                @bind="EditingModel.Bio"
                                                @bind:event="oninput"></textarea>
                                        @if (ValidationErrors.ContainsKey(nameof(EditingModel.Bio)))
                                        {
                                            <div class="invalid-feedback">
                                                @ValidationErrors[nameof(EditingModel.Bio)]
                                            </div>
                                        }
                                    </div>
                                </div>
                                
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" @onclick="CloseEdit">Cancel</button>
                                    <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                                        @if (isProcessing)
                                        {
                                            <span class="spinner-border spinner-border-sm" role="status"></span>
                                        }
                                        else
                                        {
                                            <span>Save Changes</span>
                                        }
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        }

     <!-- Candidates List -->
    @if (!GroupedCandidates.Any())
    {
        <div class="alert alert-warning text-center py-4 shadow-sm">
            <i class="bi bi-info-circle-fill me-2"></i>
            No candidates found matching your criteria
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var group in GroupedCandidates)
            {
                var position = group.Key;
                var candidates = GetPagedCandidates(position);

                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header position-header py-3">
                            <h2 class="h5 mb-0 text-white">@position Position</h2>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                @foreach (var candidate in candidates)
                                {
                                    <div class="col-12">
                                        <div class="candidate-card p-3">
                                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-center">
                                                <div class="mb-2 mb-md-0">
                                                    <h3 class="h6 mb-1">@candidate.Name</h3>
                                                    <p class="text-muted small mb-0">@candidate.Party</p>
                                                </div>
                                                <div class="candidate-actions d-flex">
                                                    <button class="btn btn-outline-primary btn-sm" 
                                                            @onclick="() => ViewProfile(candidate)"
                                                            aria-label="View candidate profile">
                                                        <i class="bi bi-eye me-1"></i>View
                                                    </button>
                                                    <button class="btn btn-outline-warning btn-sm" 
                                                            @onclick="() => EditCandidate(candidate.Id, candidate)"
                                                            aria-label="Edit candidate">
                                                        <i class="bi bi-pencil-square me-1"></i>Edit
                                                    </button>
                                                    <button class="btn btn-outline-danger btn-sm" 
                                                            @onclick="() => DeleteCandidate(candidate.Id)"
                                                            aria-label="Delete candidate">
                                                        <i class="bi bi-trash me-1"></i>Delete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</main>

@code {
    [Inject] 
    private IJSRuntime JsRuntime { get; set; }

    private string SearchTerm { get; set; } = "";
    
    private CandidateSerializedDto? SelectedCandidate { get; set; }

    private List<CandidateSerializedDto> Candidates { get; set; } = new();

    private Dictionary<string, List<CandidateSerializedDto>> GroupedCandidates { get; set; } = new();

    private Dictionary<string, int> CurrentPages { get; set; } = new();

    private const int PageSize = 3;
    private string SuccessMessage { get; set; } = "";
    private string ErrorMessage { get; set; } = "";

    [Inject]
    private ICandidatesService CandidateService { get; set; }
    
    [Inject]
    private IAuthService AuthService { get; set; }
    
    [Inject]
    private IPositionsService PositionService { get; set; }

    private EditCandidateFormModel EditingModel { get; set; } = new();

    private bool IsEditing { get; set; } = false;
    private bool IsLoading { get; set; } = false;
    private bool IsDeleting { get; set; } = false;
    private bool isProcessing { get; set; } = false;
    private bool IsEditingCandidate { get; set; } = false;
    private bool ShowEditModal { get; set; } = false;

    private List<PositionDetails> AvailablePositions { get; set; }

    private Dictionary<string, string> ValidationErrors { get; set; } = new();

    private CancellationTokenSource _messageTimeoutCts = new();
    private Guid? _candidateToDelete;

    protected override async Task OnInitializedAsync()
    {
        await LoadCandidates();
        GroupCandidates();
        InitializePagination();
    }

     private async Task HandleEditSubmit()
    {
        try
        {
            isProcessing = true;
            ValidationErrors.Clear();
            
            // Manual validation using DataAnnotations.
            var validationContext = new ValidationContext(EditingModel);
            var validationResults = new List<ValidationResult>();
            bool isValid = Validator.TryValidateObject(EditingModel, validationContext, validationResults, true);

            if (!isValid)
            {
                foreach (var validationResult in validationResults)
                {
                    foreach (var memberName in validationResult.MemberNames)
                    {
                        ValidationErrors[memberName] = validationResult.ErrorMessage;
                    }
                }
                StateHasChanged();
                return;
            }

            // Create update DTO. Note: PhotoUrl is null to avoid serialization issues.
            var updateDto = new UpdateCandidateDto(
                PositionId: EditingModel.PositionId,
                Party: EditingModel.Party,
                Bio: EditingModel.Bio,
                PhotoUrl: null 
            );

            await CandidateService.UpdateCandidateAsync(SelectedCandidate.Id, updateDto);
            SuccessMessage = "Candidate updated successfully";
            Console.WriteLine($"[DEBUG] Sending UpdateCandidate Request:\n{JsonSerializer.Serialize(updateDto, new JsonSerializerOptions { WriteIndented = true })}");

            await LoadCandidates();
            GroupCandidates();
            InitializePagination();

            SelectedCandidate = null;
            ShowEditModal = false;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Update failed: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    // Loads all candidates from the API.
    private async Task LoadCandidates()
    {
        try
        {
            var token = await AuthService.GetTokenAsync();
            CandidateService.SetBearerToken(token);
            Candidates = (await CandidateService.GetSerializedCandidatesAsync()).ToList();
            ErrorMessage = "";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading candidates: {ex.Message}";
            SuccessMessage = "";
        }
    }

    // Groups candidates by "Election - Position" key.
    private void GroupCandidates()
    {
        GroupedCandidates = Candidates
            .GroupBy(c => $"{c.Election ?? "No Election"} - {c.Position ?? "No Position"}")
            .ToDictionary(g => g.Key, g => g.OrderBy(c => c.Name).ToList());

        Console.WriteLine($"Grouped Candidates: {string.Join(", ", GroupedCandidates.Keys)}");
    }

    private void InitializePagination()
    {
        foreach (var position in GroupedCandidates.Keys)
        {
            if (!CurrentPages.ContainsKey(position))
            {
                CurrentPages[position] = 1;
            }
        }
    }

    private void HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            FilterCandidates();
        }
    }

    private void FilterCandidates()
    {
        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            GroupCandidates();
            return;
        }

        var filtered = Candidates
            .Where(c => c.Name.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                        c.Party.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                        c.Position.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                        c.Election.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase))
            .ToList();

        GroupedCandidates = filtered
            .GroupBy(c => $"{c.Election ?? "No Election"} - {c.Position ?? "No Position"}")
            .ToDictionary(g => g.Key, g => g.ToList());

        InitializePagination();
    }

    private IEnumerable<CandidateSerializedDto> GetPagedCandidates(string position)
    {
        if (!GroupedCandidates.ContainsKey(position) || !CurrentPages.ContainsKey(position))
        {
            return Enumerable.Empty<CandidateSerializedDto>();
        }

        var candidates = GroupedCandidates[position];
        return candidates.Skip((CurrentPages[position] - 1) * PageSize).Take(PageSize);
    }

    // Calculates total number of pages for a given group.
    private int GetTotalPages(string position)
    {
        return GroupedCandidates.TryGetValue(position, out var candidates) 
            ? (int)Math.Ceiling(candidates.Count / (double)PageSize)
            : 0;
    }

    // Moves to the next page for the specified group.
    private void NextPage(string position)
    {
        if (!CurrentPages.ContainsKey(position)) return;

        if (CurrentPages[position] < GetTotalPages(position))
        {
            CurrentPages[position]++;
        }
    }

    // Moves to the previous page for the specified group.
    private void PreviousPage(string position)
    {
        if (!CurrentPages.ContainsKey(position)) return;

        if (CurrentPages[position] > 1)
        {
            CurrentPages[position]--;
        }
    }

    // Deletes a candidate.
    private async Task DeleteCandidate(Guid candidateId)
    {
        // Confirm deletion
        var confirmed = await JsRuntime.InvokeAsync<bool>("confirm", 
            "Are you sure you want to delete this candidate?");
        
        if (!confirmed) return;

        try
        {
            _candidateToDelete = candidateId;
            var token = await AuthService.GetTokenAsync();
            CandidateService.SetBearerToken(token);

            await CandidateService.DeleteCandidateAsync(candidateId);
            SuccessMessage = "Candidate deleted successfully!";
            Candidates.RemoveAll(c => c.Id == candidateId);
            GroupCandidates();  
            InitializePagination();
            StateHasChanged();
            await ClearMessagesAfterDelay();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Delete failed: {ex.Message}";
            await ClearMessagesAfterDelay();
        }
        finally
        {
            _candidateToDelete = null;
            StateHasChanged();
        }
    }
    private async Task ClearMessagesAfterDelay(int delay = 3000)
    {
        _messageTimeoutCts.Cancel();
        _messageTimeoutCts = new CancellationTokenSource();
        
        try
        {
            await Task.Delay(delay, _messageTimeoutCts.Token);
            SuccessMessage = "";
            ErrorMessage = "";
            await InvokeAsync(StateHasChanged);
        }
        catch (TaskCanceledException)
        {
            // Normal operation when new message arrives
        }
    }

    // Clears success/error messages after a delay.
    private async Task ClearMessagesAfterDelay()
    {
        await Task.Delay(5000);
        SuccessMessage = "";
        ErrorMessage = "";
        StateHasChanged();
    }

    // Views candidate profile.
    private void ViewProfile(CandidateSerializedDto candidate)
    {
        SelectedCandidate = candidate;
    }

    // Closes candidate details.
    private void CloseDetails()
    {
        SelectedCandidate = null;
    }

    // Initiates candidate editing.
     private async Task EditCandidate(Guid candidateId, CandidateSerializedDto candidate)
    {
        try
        {
            isProcessing = true;
            var candidateDetails = await CandidateService.GetCandidateDetailsAsync(candidateId);
            
            AvailablePositions = (await PositionService.GetPositionsAsync()).ToList();

            EditingModel = new EditCandidateFormModel
            {
                PositionId = candidateDetails.ElectionPositionId,
                Party = candidateDetails.Party,
                Bio = candidateDetails.Bio,
                PhotoUrl = candidateDetails.PhotoUrl?.ToString()
            };

            // Verify position exists
            if (!AvailablePositions.Any(p => p.Id == EditingModel.PositionId))
            {
                ErrorMessage = "Candidate's current position is not available";
                await ClearMessagesAfterDelay();
                return;
            } 

            ShowEditModal = true;
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load candidate: {ex.Message}";
            await ClearMessagesAfterDelay();
        }
        finally
        {
            isProcessing = false;
        }
    }

   private void CloseEdit()
    {
        ShowEditModal = false;
        ValidationErrors.Clear();
        EditingModel = new EditCandidateFormModel();
        SelectedCandidate = null;
    }

    // Model for candidate editing form with DataAnnotations for validation.
    public class EditCandidateFormModel
    {
        [Required(ErrorMessage = "Position is required")]
        public Guid PositionId { get; set; }

        [StringLength(100, ErrorMessage = "Party name too long (100 char max)")]
        public string? Party { get; set; }

        [Required(ErrorMessage = "Bio is required")]
        [StringLength(500, ErrorMessage = "Bio too long (500 char max)")]
        public string Bio { get; set; } = string.Empty;

        [Url(ErrorMessage = "Invalid URL format")]
        [StringLength(255, ErrorMessage = "URL too long (255 char max)")]
        public string? PhotoUrl { get; set; }
    }
}
